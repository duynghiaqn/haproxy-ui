<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>HAProxy Manager Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-4">
<div class="container">
    <h2>HAProxy Manager Dashboard</h2>
    <p>Welcome, admin | <a href="{{ url_for('logout') }}">Logout</a></p>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
        <div class="alert alert-{{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- SSL Expiring Alerts -->
    <script>
      {% for c in expiring_certs %}
      Swal.fire({
        icon: 'warning',
        title: 'SSL sắp hết hạn!',
        text: '{{ c.domain }} còn {{ c.days_left }} ngày',
      });
      {% endfor %}
    </script>

    <!-- Domains Section -->
    <div class="card mb-4">
      <div class="card-header">Domains</div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('add_domain') }}" class="mb-2 d-flex gap-2 flex-wrap">
          <input name="domain" class="form-control" placeholder="Nhập domain">
          <button class="btn btn-primary">Add Domain</button>
        </form>

        <table class="table table-bordered table-striped">
          <thead><tr><th>Domain</th><th>Expire</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody>
          {% for c in certs %}
            <tr>
              <td>{{ c.domain }}</td>
              <td>{{ c.expire if c.expire else '-' }}</td>
              <td>{{ c.status }}</td>
              <td class="d-flex gap-1 flex-wrap">
                <form method="POST" action="{{ url_for('delete_domain', domain=c.domain) }}" class="delete-form">
                  <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>

                <form method="POST" action="{{ url_for('renew_ssl', domain=c.domain) }}" class="renew-form">
                  <button type="submit" class="btn btn-warning btn-sm">Renew SSL</button>
                </form>

                <form method="POST" action="{{ url_for('upload_pem') }}" enctype="multipart/form-data" class="upload-form d-flex gap-1">
                  <input type="hidden" name="domain" value="{{ c.domain }}">
                  <input type="file" name="pem" class="form-control form-control-sm">
                  <button type="submit" class="btn btn-success btn-sm">Upload PEM</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Backends Section -->
    <div class="card mb-4">
      <div class="card-header">Backends</div>
      <div class="card-body">
        <form method="POST" action="{{ url_for('add_backend') }}" class="mb-2 d-flex gap-2 flex-wrap">
          <input name="name" class="form-control" placeholder="Backend name" required>
          <input name="ip" class="form-control" placeholder="IP" required>
          <input name="port" class="form-control" placeholder="Port" type="number" required>
          <div class="form-check d-flex align-items-center gap-1">
            <input class="form-check-input" type="checkbox" name="ssl">
            <label class="form-check-label">SSL</label>
          </div>
          <button class="btn btn-primary">Add Backend</button>
        </form>

        <table class="table table-bordered table-striped">
          <thead><tr><th>Name</th><th>IP</th><th>Port</th><th>SSL</th><th>Actions</th></tr></thead>
          <tbody>
          {% for b in backends %}
            <tr>
              <td>{{ b.name }}</td>
              <td>{{ b.ip }}</td>
              <td>{{ b.port }}</td>
              <td>{{ 'Yes' if b.ssl else 'No' }}</td>
              <td>
                <form method="POST" action="{{ url_for('delete_backend') }}" class="delete-backend-form d-inline">
                  <input type="hidden" name="name" value="{{ b.name }}">
                  <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Backend Stats Chart -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Backend Stats</span>
        <a href="http://{{ request.host.split(':')[0] }}:1936" target="_blank" class="btn btn-sm btn-outline-secondary">HAProxy Stats</a>
      </div>
      <div class="card-body">
        <canvas id="backendChart" width="400" height="150"></canvas>
      </div>
    </div>

    <!-- Reload HAProxy -->
<div class="d-flex mb-3">
  <button class="btn btn-success me-2" onclick="haproxyAction('start')">Start HAProxy</button>
  <button class="btn btn-danger me-2" onclick="haproxyAction('stop')">Stop HAProxy</button>
  <button class="btn btn-primary" onclick="haproxyAction('reload')">Reload HAProxy</button>
</div>

    <!-- Security Settings -->
    <a href="{{ url_for('security') }}" class="btn btn-info mt-3">Security Settings</a>

</div>
<script>
function haproxyAction(action){
    Swal.fire({
        title: `Bạn có chắc muốn ${action.toUpperCase()} HAProxy?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Đồng ý',
        cancelButtonText: 'Hủy'
    }).then((result)=>{
        if(result.isConfirmed){
            fetch(`/haproxy_action/${action}`,{
                method: 'POST',
                headers:{'Content-Type':'application/x-www-form-urlencoded'}
            }).then(()=> location.reload());
        }
    });
}
</script>
<script>
document.querySelectorAll(".delete-form").forEach(f=>{
    f.addEventListener("submit", e=>{
        e.preventDefault();
        Swal.fire({
            title: 'Xác nhận xóa domain?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete',
        }).then(result=>{
            if(result.isConfirmed) f.submit();
        });
    });
});

document.querySelectorAll(".renew-form").forEach(f=>{
    f.addEventListener("submit", e=>{
        e.preventDefault();
        Swal.fire({
            title: 'Renew SSL cho domain này?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, renew',
        }).then(result=>{
            if(result.isConfirmed) f.submit();
        });
    });
});

document.querySelectorAll(".delete-backend-form").forEach(f=>{
    f.addEventListener("submit", e=>{
        e.preventDefault();
        Swal.fire({
            title: 'Xác nhận xóa backend?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete',
        }).then(result=>{
            if(result.isConfirmed) f.submit();
        });
    });
});

// Chart.js backend stats
const ctx = document.getElementById('backendChart').getContext('2d');
const sslCount = {{ backends|selectattr("ssl")|list|length }};
const nonSslCount = {{ backends|selectattr("ssl","equalto",false)|list|length }};
const backendChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['SSL Backends','Non-SSL Backends'],
        datasets: [{
            label: 'Số lượng',
            data: [sslCount, nonSslCount],
            backgroundColor: ['rgba(54, 162, 235, 0.7)','rgba(255, 206, 86, 0.7)'],
            borderColor: ['rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)'],
            borderWidth: 1
        }]
    },
    options: {
        scales: { y: { beginAtZero: true, precision:0 } }
    }
});
</script>
</body>
</html>
